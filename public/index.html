<!DOCTYPE html>
<html>
<head>
	<title>HTTP Video</title>
</head>
<body>
	<video id="videoPlayer" width="600" height="400" controls></video>
</body>
	<script type="text/javascript">
		var player = document.getElementById("videoPlayer");

		player.addEventListener("error", (err) => console.log(err));

		var mse = new (window.MediaSource || window.WebKitMediaSource());
		mse.addEventListener("sourceopen", function (evt) {
			console.log("Source opened", this);

			var videoSourceBuffer = this.addSourceBuffer('video/webm; codecs="vp9"');

			let videoBuffer = [];
			let queue = [];
			let addingFromQueue = false;
			let count = 0;

			function appendBufFromQueue(srcBuffer) {
				addingFromQueue = true;
				let buf = queue[0];
				queue.shift();

				return Boolean(buf) && (srcBuffer.appendBuffer(buf) || true);
			}

			videoSourceBuffer.addEventListener("updateend", function() {
				if(!appendBufFromQueue(this)) addingFromQueue = false;
			});

			fetch("/seyeon/1280x720_1500k.webm", {
				headers: {
					range: "0-"
				}
			})
			.then((response) => {
				var reader = response.body.getReader();
				
				(function readData() {
					reader.read()
					.then((buffer) => {
						queue.push(buffer.value);
						if(!videoSourceBuffer.updating && !addingFromQueue) {
							console.log("called: ", videoSourceBuffer, addingFromQueue);
							appendBufFromQueue(videoSourceBuffer);
						}

						if(!buffer.done) readData();
					});
				})()
			});
/*
			var xhttp = new XMLHttpRequest();
			xhttp.addEventListener("load", function() {
				console.log("Received response", this.response);
				videoSourceBuffer.appendBuffer(this.response);
			});

			xhttp.open("GET", "/seyeon/1280x720_1500k.webm");

			xhttp.setRequestHeader("range", "0-");
			xhttp.responseType = "arraybuffer";
			xhttp.send();
*/
		});

		player.src = URL.createObjectURL(mse);
	</script>
</html>